<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoCult - Tags</title>
    <script type="text/javascript" src="assets/js/d3.min.js"></script>
    <script src="assets/js/bootstrap5.3.bundle.min.js" ></script>
    <script src="assets/js/all.min.js" ></script>
    <script src="assets/js/menuSunburst.js" ></script>
    <script src="assets/js/jquery.min.js" ></script>
    <script src="assets/js/typeahead.bundle.js" ></script>
    <script src="assets/js/handlebars.min.js" ></script>
    <link href="assets/css/bootstrap5.3.min.css" rel="stylesheet" >
    <link href="assets/css/menu.css" rel="stylesheet" >
    <link href="assets/css/all.min.css" rel="stylesheet" >

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
        
</head>
<body>    
    <nav class="navbar navbar-expand-lg bg-body-tertiary bg-dark border-bottom border-bottom-dark" data-bs-theme="dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="assets/img/logoeruagreen2.png" alt="Logo" width="30" height="24" class="d-inline-block align-text-top">
                <img src="assets/img/logo-paragraphe-blanc.svg" alt="Logo" width="86"  class="d-inline-block align-text-top">
                CoCult
                <i class="fa-solid fa-table-cells"></i>
                <span id="selectSieve">Select a sieve</span>
                <i class="fa-solid fa-person-walking"></i>
                <span id="selectWalk">Select a walk</span>

            </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a id="btnTakePhoto" class="nav-link" href="#"><i class="fa-solid fa-camera-retro"></i></a>
                  </li>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa-solid fa-table-cells"></i>
                        Sieves
                </a>
                <ul id="ddSieves" class="dropdown-menu">
                </ul>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa-solid fa-person-walking"></i>
                    Walks
                </a>
                <ul id="ddWalks" class="dropdown-menu">
                </ul>
              </li>
              <li>
                    <form autocomplete="off">
                    <div class="input-group">
                        <span class="input-group-text" id="url-addon">@</span>
                        <input id="inptUrl" type="text" class="form-control" 
                            size="64" placeholder="" aria-label="" aria-describedby="url-addon">
                    </div>
                    </form>
                </li>                                                                        


            </ul>
      </div>
</div>
      </nav>


    <div class="container-fluid px-0">
      <div class="row g-0">
  
        <!-- First column -->
        <div class="col">
            <div id="carouselCocult" class="carousel slide"  >
                <div id="carouselItems" class="carousel-inner">
    
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselCocult" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselCocult" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>

        </div>
        <!-- First column -->
  
        <!-- Second column -->
        <div class="col vh-100">
            <div id="map" class="map"></div>
  
        </div>
        <!-- Second column -->
  
      </div>
    </div>
  
    
    <div id="popup"></div>
    <div id="dataviz"></div>

    <div id='modalTakePhoto' class="modal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add Photo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="getWalkId" type="hidden" value="">
                <input id="getWalkLbl" type="hidden" value="">    
                <div class="mb-3">
                    <label for="inputText" class="form-label">Title</label>
                    <input type="text" class="form-control" id="inputText" placeholder="precise title">
                </div>
                <div class="mb-3" id="getWalk">
                    <label for="inputWalk" class="form-label">Choose / add a walk</label>
                    <input id="inputWalk" class="form-control typeahead" type="text" placeholder="">
                </div>        
                <div class="mb-3">
                    <label for="formFile" class="form-label">Take photo</label>
                    <input class="form-control" type="file" id="formFile">
                </div>                  
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button id="btnSendPhoto" type="button" class="btn btn-danger" data-bs-dismiss="modal">Send</button>
            </div>
          </div>
        </div>
      </div>

      <div id="loading-container">
        <div class="loadingio-spinner-double-ring-4dols36ufwg" id="ws-loading">
            <div class="ldio-6pd26u1x99x">
            <div></div>
            <div></div>
            <div><div></div></div>
            <div><div></div></div>
        </div></div>
    </div>

</body>
<script type="module">
import {auth} from './modules/auth.js';
import {omk} from './modules/omk.js';
import {appUrl} from './modules/appUrl.js';




let curPosi, curMedia, menu, dataMenu, unescoGraph, unescoVocabs=[], vs
        , unescoEdgePredicate, unescoRegions=[], medias,
        carousel, walks, curwait = 0,
        wM = 20, hM = 20, idItemSetWalk = 4499,
        a = new auth({'navbar':d3.select('#navbarMain'),
            mail:'samuel.szoniecky@univ-paris8.fr',
            apiOmk:'omk/api',
            ident: 'kXaKZ6xsWlxkjjHKgwXh3lEz7QgZMLsF',
            key:'5lu3xO1uh0QeGYyQSUAztqmcHC3hzeat',        
        }),
        modalTakePhoto = new bootstrap.Modal(document.getElementById('modalTakePhoto'), 
            {keyboard: false}),
        aUrl = new appUrl({
            'tgtIn':d3.select("#inptUrl").node(),
            'tgtBtn':d3.select("#url-addon"),
            'url':new URL(document.location)
        });

a.getUser(u=>{
    console.log(u);
});


let rc, map = L.map('map');

L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

rc = L.Routing.control({
    waypoints: [
        L.latLng(48.945515021571346, 2.3624837704718873),
        L.latLng(55.653641447939265, 12.140908643986014),
        L.latLng(39.08529335581509, 26.568977968147035),
    ],
    routeWhileDragging: false
}).addTo(map);
rc.hide();


//init walks
walks = a.omk.searchItems('item_set_id='+idItemSetWalk);
//init modal take photo
var sgtWalk = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('o:title'),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  identify: function(obj) { 
      return obj['o:id']; 
    },
  remote: {
    url: a.omk.api+'items?item_set_id='+idItemSetWalk+'&property[0][property]=1&property[0][type]=in&property[0][text]=%QUERY&sort_by=title',
    wildcard: '%QUERY'
  }
});
$('#getWalk .typeahead').typeahead(null, {
    name: 'omk-walks',
    display: 'o:title',
    source: sgtWalk,
    templates: {
        empty: function(context){
            //document.getElementById('btnSendPhoto').style.display='none';  
            document.getElementById('getWalkLbl').value=context.query;
            document.getElementById('getWalkId').value=0;
        },
        suggestion: Handlebars.compile('<div><strong>{{o:title}}</strong> – {{o:id}}</div>')
    }  
    });
$('#getWalk .typeahead').bind('typeahead:select', function(ev, suggestion) {
    document.getElementById('getWalkId').value=suggestion["o:id"];
    document.getElementById('getWalkLbl').value=suggestion["o:title"];
    //document.getElementById('btnSendPhoto').style.display='block';  
    });    

//init take photo
d3.select('#btnTakePhoto').on('click',showTakePhoto);
d3.select('#btnSendPhoto').on('click',e=>{
    let idWalk = document.getElementById("getWalkId").value;
    if(idWalk=="0"){
        //create walk
        a.omk.createRessource({'dcterms:title':document.getElementById("getWalkLbl").value,
                'o:item_set':idItemSetWalk},(d)=>{
            walks.push(d);
            document.getElementById("getWalkId").value=d['o:id'];
            setMenu('#ddWalks',walks,'o:title',showWalk);
            addTakePhoto(d);
        }); 
    }else{
        addTakePhoto(walks.filter(w=>w['o:id']==idWalk)[0]);
    }
});

Promise.all([d3.json('assets/data/menu.json'),
        d3.json('assets/data/unesco_graph_en.json'
    )]).then(datas=>{
    dataMenu=datas[0];
    unescoGraph = datas[1];

    //update menus
    setMenu('#ddWalks',walks,'o:title',showWalk);
    setMenu('#ddSieves',dataMenu,'name',setSieve);

    //get concepts
    for (const key in unescoGraph.nodes) {
        const e = unescoGraph.nodes[key];
        e.k = key;
        if(e.type=="concept")unescoVocabs.push(e);
        if(e.type=="region" && e.label!="")unescoRegions.push(e);
    }
    //get concepts uses
    unescoGraph.edges.forEach(e=>{
        if(e.object.substr(0,21)=='vocabulary_thesaurus_' 
            || e.subject.substr(0,21)=='vocabulary_thesaurus_'){
            vs = unescoVocabs.filter(vc=>vc.k==e.object);
            vs.forEach(v=>v.weight = v.weight ? v.weight + e.weight : e.weight);
            vs = unescoVocabs.filter(vc=>vc.k==e.subject);
            vs.forEach(v=>v.weight = v.weight ? v.weight + e.weight : e.weight);
        }        
    })
    //get type edge
    //unescoEdgePredicate = Array.from(d3.group(unescoGraph.edges, b => b.predicate), ([key, value]) => ({key, value})),

    if(aUrl.params && aUrl.params.has('sieve'))setSieve(null,dataMenu.filter(m=>m['o:id']==aUrl.params.get('sieve'))[0]);
    if(aUrl.params && aUrl.params.has('walk'))showWalk(null,walks.filter(w=>w['o:id']==aUrl.params.get('walk'))[0]);


    hideLoader();
})
function setMenu(s,data,lbl,fct){
    d3.select(s).selectAll('li').data(data)
      .join(
        enter => enter.append('li')
            .append('a').attr('class',"dropdown-item")
            .html(d=>d[lbl])
            .on('click',fct),
        update => update.select('a').html(d=>d[lbl]),
        exit => exit.remove()
      );
}

function addTakePhoto(w){
    let data = {'dcterms:title':document.getElementById("inputText").value,
            'file':document.querySelector("#formFile").files[0]
        };
    a.omk.createRessource(data,(d)=>{
        //add photo to the walk
        let fd = a.omk.formatData({'dcterms:hasPart':{'rid':d['o:id']}});
        if(w['dcterms:hasPart'])w['dcterms:hasPart'].push(fd['dcterms:hasPart'][0]);
        else w['dcterms:hasPart']=fd['dcterms:hasPart'];
        a.omk.updateRessource(w['o:id'],null,'items', w,'PATCH',rs=>{
                console.log(rs);
            })
    }); 
}
function showTakePhoto(e){
    modalTakePhoto.show();
}
function setSieve(e,d){
    aUrl.change('sieve',d['o:id']);
    showLoader();
    d3.json(d.sources).then(data=>{
        switch (d.function) {
            case "menuUnesco":
                data.children[0].children = unescoRegions.map(r=>{
                    return {"size" : 1,"id": r.k, "name": r.label};
                });                
                break;
        }
        d3.select("#dataviz").select('svg').remove();
        d3.select("#selectSieve").html(d.name);
        //console.log(unescoVocabs);        
        menu  = new menuSunburst({
            'idCont': "dataviz",
            'width':window.screen.width/3,
            'data' : data,
            'cbEndInit':'hide',
            'cbValidate' : function(selectedItems) {
                saveMarkers(d, selectedItems);
            }
        });
        hideLoader();
    });    
}
function saveMarkers(d,selectedItems){
    showLoader();
    curMedia['oa:hasBody'].push({
        'actant':a.omk.mail,
        'sieves':d,
        'posi':curPosi,
        'data':selectedItems.map(s=>s.data),
        'timestamp':Date.now()
    });
    updateMarkers(curMedia);
    //ste update data to omk
    let updMedia = JSON.parse(JSON.stringify(curMedia)),
        body = a.omk.formatData({'oa:hasBody':updMedia['oa:hasBody']});
    updMedia['oa:hasBody']=body['oa:hasBody'];
    a.omk.updateRessource(updMedia['o:id'],null,'media',updMedia,'PATCH',markersIsSave);
    menu.hideMenu();
}
function markersIsSave(d){
    hideLoader();
}

function showWalk(e,d){
    showLoader();
    aUrl.change('walk',d['o:id']);
    d3.select('#selectWalk').html(d['o:title']);
    setTimeout(function(){
        if(!d.medias){
            //get medias from cocult site walk
            a.omk.getMedias(d,'dcterms:hasPart');
            d.medias.forEach(m=>{
                if(m['oa:hasBody']){
                    m['oa:hasBody']=m['oa:hasBody'].map(b=>b['@value']?JSON.parse(b['@value']):b);                
                }
                if(m["dcterms:spatial"]){
                    m.geo = ParseDMS(m["dcterms:spatial"][0]["@value"]);
                }
            })
        }
    
        //construct map
        rc.setWaypoints([]);
        if(d.medias.length){
            let wp = d.medias.filter(m=>m.geo).map(m=>L.latLng(m.geo.lat,m.geo.lng));
            rc.setWaypoints(wp);
        }

        d3.select('#carouselItems').selectAll('div').remove();
        let myCarousel = document.querySelector('#carouselCocult'),
            slides = d3.select('#carouselItems').selectAll('div').data(d.medias).enter().append('div')
            .attr("class",(d,i)=>"carousel-item"+(i==0 ? ' active' : ' '));
        slides.append('img')
            .attr('src',d=>d.thumbnail_display_urls.large)
            .attr('class',"d-block w-100")
            .on('click',(e,d)=>{
                curPosi = {'x':e.layerX,'y':e.layerY};
                curMedia = d;
                if(!curMedia['oa:hasBody'])curMedia['oa:hasBody'] = []
                else curMedia['oa:hasBody']=curMedia['oa:hasBody'].map(b=>b['@value']?JSON.parse(b['@value']):b);
                menu.showNew();
            });
        slides.append('div').attr('class','clearfix markers').attr('id',d=>'markers'+d['o:id']);
        carousel = new bootstrap.Carousel(myCarousel, {
                    interval : 3000,
                    ride : false
                });
        myCarousel.addEventListener('slide.bs.carousel', event => {
            //show markers of slide
            aUrl.change('media',event.to);
            curMedia = d.medias[(event.to)]
            updateMarkers(curMedia);
        })            
        //carousel.cycle();    
        //show markers of first slide
        curMedia = d.medias[0]
        updateMarkers(curMedia);
        if(aUrl.params && aUrl.params.has('media'))carousel.to(aUrl.params.get('media'));

        hideLoader();
    }, 1);    

}

//many thanks to https://stackoverflow.com/questions/1140189/converting-latitude-and-longitude-to-decimal-values
function ParseDMS(input) {
    var parts = input.split(/[^\d\w\.]+/);    
    var lat = ConvertDMSToDD(parts[0], parts[2], parts[3], parts[4]);
    var lng = ConvertDMSToDD(parts[5], parts[7], parts[8], parts[9]);

    return {
        lat : lat,
        lng: lng,
        pos : lat + ',' + lng
    }
}
function ConvertDMSToDD(degrees, minutes, seconds, direction) {   
    var dd = Number(degrees) + Number(minutes)/60 + Number(seconds)/(60*60);

    if (direction == "S" || direction == "W") {
        dd = dd * -1;
    } // Don't do anything for N or E
    return dd;
}
function updateMarkers(d){
    if(d.geo)map.setView(new L.LatLng(d.geo.lat, d.geo.lng),18);
    if(!d['oa:hasBody'])return;
    d3.select('#markers'+d['o:id']).selectAll('div').data(d['oa:hasBody']).join(
            enter => {
                enter.append('div').style('position','absolute')
                    .style('top',d=>(d.posi.y-(hM/2))+'px')
                    .style('left',d=>(d.posi.x-(wM/2))+'px')
                    .style('height',hM+'px').style('width',wM+'px')
                    .style('background',getGradient)
                    .on('click',showMarkerData);       
                },
            update => {
                update.style('top',d=>(d.posi.y-(hM/2))+'px')
                    .style('left',d=>(d.posi.x-(wM/2))+'px');
                },
            exit => {
                exit.remove();
            });    
}
function getGradient(d){
    return 'linear-gradient('+d.data.map(c=>c.color).join()+')';
}
function showMarkerData(e,d){
    console.log(d);
    d3.select('#popup')
        .style('display','block')
        .style('top',d.posi.y+(hM/2)+'px')
        .style('left',d.posi.x+(wM/2)+'px')
        .on('click',hideMarkerData)       
        .selectAll('div').data(d.data).join(
            enter => {
                enter.append('div')
                    .style('padding','3px')
                    .style('background-color',d=>d.color)
                    .html(d=>d.name)
                },
            update => {
                update.style('background-color',d=>d.color)
                    .html(d=>d.name)
                },
            exit => {
                exit.remove();
            });       
}
function hideMarkerData(e){
    d3.select(e.currentTarget).style('display','none');
}
async function showLoader() {
    curwait ++;
	d3.select("#ws-loading").style("display", "inline-block")
}
function hideLoader() {
    curwait --;
	if(curwait<1){
        d3.select("#ws-loading").style("display", "none");
        curwait=0;
    }       
}


    
</script>

</html>